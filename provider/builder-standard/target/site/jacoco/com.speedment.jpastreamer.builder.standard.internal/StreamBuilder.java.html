<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StreamBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Builder - Standard</a> &gt; <a href="index.source.html" class="el_package">com.speedment.jpastreamer.builder.standard.internal</a> &gt; <span class="el_source">StreamBuilder.java</span></div><h1>StreamBuilder.java</h1><pre class="source lang-java linenums">package com.speedment.jpastreamer.builder.standard.internal;

import com.speedment.jpastreamer.pipeline.Pipeline;
import com.speedment.jpastreamer.pipeline.intermediate.IntermediateOperation;
import com.speedment.jpastreamer.pipeline.intermediate.IntermediateOperationFactory;
import com.speedment.jpastreamer.pipeline.terminal.TerminalOperation;
import com.speedment.jpastreamer.pipeline.terminal.TerminalOperationFactory;
import com.speedment.jpastreamer.renderer.RenderResult;
import com.speedment.jpastreamer.renderer.Renderer;

import java.util.Comparator;
import java.util.Iterator;
import java.util.Optional;
import java.util.Spliterator;
import java.util.function.*;
import java.util.stream.*;

import static com.speedment.jpastreamer.builder.standard.internal.StreamBuilderUtil.MSG_STREAM_LINKED_CONSUMED_OR_CLOSED;
import static java.util.Objects.*;

final class StreamBuilder&lt;T&gt; implements Stream&lt;T&gt; {

    private final Factories factories;
    private final Renderer renderer;
    private final Pipeline&lt;T&gt; pipeline;
    private final BaseStreamSupport support;

    // Used to prevent improper reuse of builder
    private boolean linkedConsumedOrClosed;

    StreamBuilder(final Factories factories,
                  final Class&lt;T&gt; root,
<span class="fc" id="L33">                  final Renderer renderer) {</span>

<span class="fc" id="L35">        this.factories = requireNonNull(factories);</span>
<span class="fc" id="L36">        this.renderer = requireNonNull(renderer);</span>
<span class="fc" id="L37">        this.pipeline = factories.pipeline().createPipeline(requireNonNull(root));</span>
<span class="fc" id="L38">        support = new BaseStreamSupport(pipeline);</span>
<span class="fc" id="L39">    }</span>

    @Override
    public Stream&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate) {
<span class="fc" id="L43">        add(iof().createFilter(predicate));</span>
<span class="fc" id="L44">        return this;</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public &lt;R&gt; Stream&lt;R&gt; map(Function&lt;? super T, ? extends R&gt; mapper) {
<span class="nc" id="L50">        add(iof().createMap(mapper));</span>
<span class="nc" id="L51">        return (Stream&lt;R&gt;) this;</span>
    }

    @Override
    public IntStream mapToInt(ToIntFunction&lt;? super T&gt; mapper) {
<span class="nc" id="L56">        add(iof().createMapToInt(mapper));</span>
<span class="nc" id="L57">        linked();</span>
<span class="nc" id="L58">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public LongStream mapToLong(ToLongFunction&lt;? super T&gt; mapper) {
<span class="nc" id="L63">        add(iof().createMapToLong(mapper));</span>
<span class="nc" id="L64">        linked();</span>
<span class="nc" id="L65">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public DoubleStream mapToDouble(ToDoubleFunction&lt;? super T&gt; mapper) {
<span class="nc" id="L70">        add(iof().createMapToDouble(mapper));</span>
<span class="nc" id="L71">        linked();</span>
<span class="nc" id="L72">        throw new UnsupportedOperationException();</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public &lt;R&gt; Stream&lt;R&gt; flatMap(Function&lt;? super T, ? extends Stream&lt;? extends R&gt;&gt; mapper) {
<span class="nc" id="L78">        add(iof().createFlatMap(mapper));</span>
<span class="nc" id="L79">        return (Stream&lt;R&gt;) this;</span>
    }

    @Override
    public IntStream flatMapToInt(Function&lt;? super T, ? extends IntStream&gt; mapper) {
<span class="nc" id="L84">        add(iof().createFlatMapToInt(mapper));</span>
<span class="nc" id="L85">        linked();</span>
<span class="nc" id="L86">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public LongStream flatMapToLong(Function&lt;? super T, ? extends LongStream&gt; mapper) {
<span class="nc" id="L91">        add(iof().createFlatMapToLong(mapper));</span>
<span class="nc" id="L92">        linked();</span>
<span class="nc" id="L93">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public DoubleStream flatMapToDouble(Function&lt;? super T, ? extends DoubleStream&gt; mapper) {
<span class="nc" id="L98">        add(iof().createFlatMapToDouble(mapper));</span>
<span class="nc" id="L99">        linked();</span>
<span class="nc" id="L100">        throw new UnsupportedOperationException();</span>
    }

    @Override
    public Stream&lt;T&gt; distinct() {
<span class="nc" id="L105">        add(iof().acquireDistinct());</span>
<span class="nc" id="L106">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; sorted() {
<span class="nc" id="L111">        add(iof().acquireSorted());</span>
<span class="nc" id="L112">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; sorted(Comparator&lt;? super T&gt; comparator) {
<span class="nc" id="L117">        add(iof().createSorted(comparator));</span>
<span class="nc" id="L118">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; peek(Consumer&lt;? super T&gt; action) {
<span class="nc" id="L123">        add(iof().createPeek(action));</span>
<span class="nc" id="L124">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; limit(long maxSize) {
<span class="fc" id="L129">        add(iof().createLimit(maxSize));</span>
<span class="fc" id="L130">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; skip(long n) {
<span class="fc" id="L135">        add(iof().createSkip(n));</span>
<span class="fc" id="L136">        return this;</span>
    }

    @Override
    public void forEach(Consumer&lt;? super T&gt; action) {
<span class="nc" id="L141">        set(tof().createForEach(action));</span>
<span class="nc" id="L142">        renderAndThenAccept();</span>
<span class="nc" id="L143">    }</span>

    @Override
    public void forEachOrdered(Consumer&lt;? super T&gt; action) {
<span class="nc" id="L147">        set(tof().createForEachOrdered(action));</span>
<span class="nc" id="L148">        renderAndThenAccept();</span>
<span class="nc" id="L149">    }</span>

    @Override
    public Object[] toArray() {
<span class="nc" id="L153">        set(tof().acquireToArray());</span>
<span class="nc" id="L154">        return renderAndThenApply();</span>
    }

    @Override
    public &lt;A&gt; A[] toArray(IntFunction&lt;A[]&gt; generator) {
<span class="nc" id="L159">        set(tof().createToArray(generator));</span>
<span class="nc" id="L160">        return renderAndThenApply();</span>
    }

    @Override
    public T reduce(T identity, BinaryOperator&lt;T&gt; accumulator) {
<span class="nc" id="L165">        set(tof().createReduce(identity, accumulator));</span>
<span class="nc" id="L166">        return renderAndThenApply();</span>
    }

    @Override
    public Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator) {
<span class="nc" id="L171">        set(tof().createReduce(accumulator));</span>
<span class="nc" id="L172">        return renderAndThenApply();</span>
    }

    @Override
    public &lt;U&gt; U reduce(U identity, BiFunction&lt;U, ? super T, U&gt; accumulator, BinaryOperator&lt;U&gt; combiner) {
<span class="nc" id="L177">        set(tof().createReduce(identity, accumulator, combiner));</span>
<span class="nc" id="L178">        return renderAndThenApply();</span>
    }

    @Override
    public &lt;R&gt; R collect(Supplier&lt;R&gt; supplier, BiConsumer&lt;R, ? super T&gt; accumulator, BiConsumer&lt;R, R&gt; combiner) {
<span class="nc" id="L183">        set(tof().createCollect(supplier, accumulator, combiner));</span>
<span class="nc" id="L184">        return renderAndThenApply();</span>
    }

    @Override
    public &lt;R, A&gt; R collect(Collector&lt;? super T, A, R&gt; collector) {
<span class="nc" id="L189">        set(tof().createCollect(collector));</span>
<span class="nc" id="L190">        return renderAndThenApply();</span>
    }

    @Override
    public Optional&lt;T&gt; min(Comparator&lt;? super T&gt; comparator) {
<span class="nc" id="L195">        set(tof().createMin(comparator));</span>
<span class="nc" id="L196">        return renderAndThenApply();</span>
    }

    @Override
    public Optional&lt;T&gt; max(Comparator&lt;? super T&gt; comparator) {
<span class="nc" id="L201">        set(tof().createMax(comparator));</span>
<span class="nc" id="L202">        return renderAndThenApply();</span>
    }

    @Override
    public long count() {
<span class="fc" id="L207">        set(tof().acquireCount());</span>
<span class="fc" id="L208">        return renderAndThenApplyAsLong();</span>
    }

    @Override
    public boolean anyMatch(Predicate&lt;? super T&gt; predicate) {
<span class="nc" id="L213">        set(tof().createAnyMatch(predicate));</span>
<span class="nc" id="L214">        return renderAndThenTest();</span>
    }

    @Override
    public boolean allMatch(Predicate&lt;? super T&gt; predicate) {
<span class="nc" id="L219">        set(tof().createAllMatch(predicate));</span>
<span class="nc" id="L220">        return renderAndThenTest();</span>
    }

    @Override
    public boolean noneMatch(Predicate&lt;? super T&gt; predicate) {
<span class="nc" id="L225">        set(tof().createNoneMatch(predicate));</span>
<span class="nc" id="L226">        return renderAndThenTest();</span>
    }

    @Override
    public Optional&lt;T&gt; findFirst() {
<span class="fc" id="L231">        set(tof().acquireFindFirst());</span>
<span class="fc" id="L232">        return renderAndThenApply();</span>
    }

    @Override
    public Optional&lt;T&gt; findAny() {
<span class="nc" id="L237">        set(tof().acquireFindAny());</span>
<span class="nc" id="L238">        return renderAndThenApply();</span>
    }

    @Override
    public Iterator&lt;T&gt; iterator() {
<span class="nc" id="L243">        set(tof().acquireIterator());</span>
<span class="nc" id="L244">        return renderAndThenApply();</span>
    }

    @Override
    public Spliterator&lt;T&gt; spliterator() {
<span class="nc" id="L249">        set(tof().acquireSpliterator());</span>
<span class="nc" id="L250">        return renderAndThenApply();</span>
    }

    @Override
    public boolean isParallel() {
<span class="nc" id="L255">        return pipeline.isParallel();</span>
    }

    @Override
    public Stream&lt;T&gt; sequential() {
<span class="nc" id="L260">        pipeline.parallel();</span>
<span class="nc" id="L261">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; parallel() {
<span class="nc" id="L266">        pipeline.parallel();</span>
<span class="nc" id="L267">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; unordered() {
<span class="nc" id="L272">        pipeline.ordered(false);</span>
<span class="nc" id="L273">        return this;</span>
    }

    @Override
    public Stream&lt;T&gt; onClose(Runnable closeHandler) {
<span class="nc" id="L278">        pipeline.closeHandlers().add(closeHandler);</span>
<span class="nc" id="L279">        return this;</span>
    }

    @Override
    public void close() {
        // Close can be called even though the
        // stream is consumed.
        //
        // The stream has never been started so
        // we just run the close handlers.
        // Todo: Make it Exception tolerant
<span class="nc" id="L290">        closed();</span>
<span class="nc" id="L291">        StreamBuilderUtil.runAll(pipeline.closeHandlers());</span>
<span class="nc" id="L292">        pipeline.closeHandlers().clear(); // Only run once</span>
<span class="nc" id="L293">    }</span>

    private void linked() {
<span class="nc" id="L296">        linkedConsumedOrClosed = true;</span>
<span class="nc" id="L297">    }</span>

    private void consumed() {
<span class="fc" id="L300">        linkedConsumedOrClosed = true;</span>
<span class="fc" id="L301">    }</span>

    private void closed() {
<span class="nc" id="L304">        linkedConsumedOrClosed = true;</span>
<span class="nc" id="L305">    }</span>

    private void assertNotLikedConsumedOrClosed() {
<span class="fc bfc" id="L308" title="All 2 branches covered.">        if (linkedConsumedOrClosed)</span>
<span class="fc" id="L309">            throw new IllegalStateException(MSG_STREAM_LINKED_CONSUMED_OR_CLOSED);</span>
<span class="fc" id="L310">    }</span>

    private IntermediateOperationFactory iof() {
<span class="fc" id="L313">        return factories.intermediate();</span>
    }

    private TerminalOperationFactory tof() {
<span class="fc" id="L317">        return factories.terminal();</span>
    }

    private void add(final IntermediateOperation&lt;Stream&lt;T&gt;, ?&gt; intermediateOperation) {
<span class="fc" id="L321">        assertNotLikedConsumedOrClosed();</span>
<span class="fc" id="L322">        pipeline.intermediateOperations().add(intermediateOperation);</span>
<span class="fc" id="L323">    }</span>

    private void set(final TerminalOperation&lt;Stream&lt;T&gt;, ?&gt; terminalOperation) {
<span class="fc" id="L326">        assertNotLikedConsumedOrClosed();</span>
<span class="fc" id="L327">        consumed();</span>
<span class="fc" id="L328">        pipeline.terminatingOperation(terminalOperation);</span>
<span class="fc" id="L329">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    private &lt;R&gt; R renderAndThenApply() {
<span class="fc" id="L333">        final RenderResult&lt;T&gt; renderResult = renderer.render(pipeline);</span>
<span class="fc" id="L334">        return ((TerminalOperation&lt;Stream&lt;T&gt;, R&gt;) renderResult.terminalOperation())</span>
<span class="fc" id="L335">                .function()</span>
<span class="fc" id="L336">                .apply(renderResult.stream());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private long renderAndThenApplyAsLong() {
<span class="fc" id="L341">        final RenderResult&lt;T&gt; renderResult = renderer.render(pipeline);</span>
<span class="fc" id="L342">        return ((TerminalOperation&lt;Stream&lt;T&gt;, Long&gt;) renderResult.terminalOperation())</span>
<span class="fc" id="L343">                .toLongFunction()</span>
<span class="fc" id="L344">                .applyAsLong(renderResult.stream());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private boolean renderAndThenTest() {
<span class="nc" id="L349">        final RenderResult&lt;T&gt; renderResult = renderer.render(pipeline);</span>
<span class="nc" id="L350">        return ((TerminalOperation&lt;Stream&lt;T&gt;, Long&gt;) renderResult.terminalOperation())</span>
<span class="nc" id="L351">                .predicate()</span>
<span class="nc" id="L352">                .test(renderResult.stream());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private void renderAndThenAccept() {
<span class="nc" id="L357">        final RenderResult&lt;T&gt; renderResult = renderer.render(pipeline);</span>
<span class="nc" id="L358">        ((TerminalOperation&lt;Stream&lt;T&gt;, ?&gt;) renderResult.terminalOperation())</span>
<span class="nc" id="L359">                .consumer()</span>
<span class="nc" id="L360">                .accept(renderResult.stream());</span>
<span class="nc" id="L361">    }</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>