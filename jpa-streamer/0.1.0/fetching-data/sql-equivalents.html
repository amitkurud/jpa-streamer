<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SQL Equivalents :: JPA Streamer Docs</title>
    <meta name="generator" content="Antora 2.3.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">JPA Streamer Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="jpa-streamer" data-version="0.1.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../introduction/overview.html">JPAStreamer Docs</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Introduction</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../introduction/overview.html">Overview</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Getting Started</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/installation.html">Installing JPAStreamer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/quick-start.html">Quick Start with JPAStreamer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Stream Fundamentals</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/what_is_a_stream.html">What is a Stream?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/intermediate_operations.html">Intermediate Operations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/terminal_operations.html">Terminal Operations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../stream-fundamentals/other_operations.html">Other Operations</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fetching Data</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="sql-equivalents.html">SQL Equivalents</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="stream-examples.html">Stream Examples</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">JPAStreamer Docs</span>
    <span class="version">0.1.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">JPAStreamer Docs</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../introduction/overview.html">0.1.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../introduction/overview.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../introduction/overview.html">JPAStreamer Docs</a></li>
    <li>Fetching Data</li>
    <li><a href="sql-equivalents.html">SQL Equivalents</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">SQL Equivalents</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter contains a number of typical database queries that can be expressed using JPAStreamer. For users that are accustomed to SQL, this chapter provides an overview of how to translate SQL to Streams. The examples included in this chapter are based on the <a href="https://dev.mysql.com/doc/sakila/en/">MySQL "sakila" example database</a>, which models a classic movie rental store. An object that corresponds to a row in the database are, by convention, called an "Entity".</p>
</div>
<div class="paragraph">
<p>The table below gives an overview of how SQL operators map to the Java Stream API.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">SQL</th>
<th class="tableblock halign-left valign-top">Java Stream</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">FROM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">stream()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">WHERE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter() (before collecting)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ORDER BY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sorted()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">skip()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LIMIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">limit()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">COUNT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">count()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SELECT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">map()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">HAVING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">filter() (after collecting)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOIN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">flatmap()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">UNION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">concat(s0, s1).distinct()</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GROUP BY</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">collect(groupingBY())</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="_from"><a class="anchor" href="#_from"></a>FROM</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>FROM</code> can be expressed using <code>.stream()</code>. To access this method, you need access to an instance of a <code>JPAStreamer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">   JPAStreamer jpaStreamer = JPAStreamer.createJPAStreamerBuilder("sakila") <i class="conum" data-value="1"></i><b>(1)</b>
    build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>"sakila" is to be replaced with the name of the relevant persistence unit</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The method <code>.stream()</code> accepts a reference to the Entity representing the table to be streamed. For example, the table 'film' has a corresponding <code>Film</code> Entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Film {

    @Id
    @Column(name = "film_id", columnDefinition = "smallint(5)")
    private Integer filmId;

    @Column(name = "title", columnDefinition = "varchar(255)")
    private String title;

    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This entity can be streamed like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">   jpaStreamer.stream(Film.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will create a <code>Stream</code> with all the <code>Film</code> entities in the Film table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Film { filmId = 1, title = ACADEMY DINOSAUR, ...
Film { filmId = 2, title = ACE GOLDFINGER, ...
Film { filmId = 3, title = ADAPTATION HOLES, ...
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_where"><a class="anchor" href="#_where"></a>WHERE</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>WHERE</code> can be expressed using <code>.filter()</code>.</p>
</div>
<div class="paragraph">
<p>By applying a <code>filter</code> to a <code>Stream</code>, certain entities can be retained in the <code>Stream</code> and other entities can be dropped. For example,
to find a long film (of length greater than 120 minutes) you can apply a <code>filter</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    jpaStreamer.stream(Film.class)
        .filter(Film$.length.greaterThan(120))
        .forEachOrdered(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Optional[FilmImpl { filmId = 5, title = AFRICAN EGG,... , length = 130, ...]</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
An important property with JPAStreamer streams is that they are able to optimize their own pipeline by introspection. It looks like the <code>Stream</code> will iterate over all rows in the 'film' table but this is not the case. Instead, JPAStreamer is able to optimize the resulting query in the background which is then passed to the used JPA provider. This means that only the relevant entities are pulled in from the database into the <code>Stream</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_order_by"><a class="anchor" href="#_order_by"></a>ORDER BY</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>ORDER BY</code> can be expressed using <code>.sorted()</code>.</p>
</div>
<div class="paragraph">
<p>Sorting all our films based on length can be done this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    List&lt;Film&gt; filmsInLengthOrder = jpaStreamer.stream(Films.class)
        .sorted(Film$.length) <i class="conum" data-value="1"></i><b>(1)</b>
        .collect(Collectors.toList());</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descending order can be obtained by calling, for example, <code>Film$.length.reversed()</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The list will have the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Film { filmId = 15, title = ALIEN CENTER, ..., length = 46, ...
Film { filmId = 469, title = IRON MOON, ..., length = 46, ...
Film { filmId = 730, title = RIDGEMONT SUBMARINE, ..., length = 46, ...
Film { filmId = 504, title = KWAI HOMEWARD, ..., length = 46, ...
Film { filmId = 505, title = LABYRINTH LEAGUE, ..., length = 46, ...
Film { filmId = 784, title = SHANGHAI TYCOON, ..., length = 47, ...
Film { filmId = 869, title = SUSPECTS QUILLS, ..., length = 47, ...
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Several "ORDER BY" columns can be used by composing comparators:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.sorted(Film$.length.thenComparing(Film$.title.comparator()) <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>.comparator()</code> method must be used for secondary fields.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_offset"><a class="anchor" href="#_offset"></a>OFFSET</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>OFFSET</code> can be expressed using <code>.skip()</code>.</p>
</div>
<div class="paragraph">
<p>The <code>.skip()</code> operation is useful to skip a number of records before using them. Suppose you want to print out the films in title order but staring from the 100:th film then the skip-operation can be used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    films.stream()
        .sorted(Film$.title)
        .skip(100)
        .forEachOrdered(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Film { filmId = 101, title = BROTHERHOOD BLANKET, ...
Film { filmId = 102, title = BUBBLE GROSSE, ...
Film { filmId = 103, title = BUCKET BROTHERHOOD, ...
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_limit"><a class="anchor" href="#_limit"></a>LIMIT</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LIMIT</code> can be expressed using <code>.limit()</code>.</p>
</div>
<div class="paragraph">
<p>The number of records in a <code>Stream</code> can be controlled using the <code>.limit()</code> operation. This example will print out the 3 first films in title order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    jpaStreamer.stream(Film.class)
        .sorted(Film$.title)
        .limit(3)
        .forEachOrdered(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Film { filmId = 1, title = ACADEMY DINOSAUR, ...
Film { filmId = 2, title = ACE GOLDFINGER, ...
Film { filmId = 3, title = ADAPTATION HOLES, ...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_combining_offset_and_limit"><a class="anchor" href="#_combining_offset_and_limit"></a>Combining OFFSET and LIMIT</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>LIMIT X OFFSET Y</code> can be expressed by <code>.skip(y).limit(x)</code> (note the order of <code>skip</code> and <code>limit</code>)</p>
</div>
<div class="paragraph">
<p>There are many applications where both <code>.skip()</code> and <code>.limit()</code> are used. Remember that the order of these stream operations matters and that the order is different from what you might be used to from SQL. The following example expresses a stream used to fetch 50 films starting from the 100:th film in natural title order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    films.stream()
        .sorted(Film.TITLE)
        .skip(100)
        .limit(50)
        .forEachOrdered(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Film { filmId = 101, title = BROTHERHOOD BLANKET, ...
Film { filmId = 102, title = BUBBLE GROSSE, ...
Film { filmId = 103, title = BUCKET BROTHERHOOD, ...
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_count"><a class="anchor" href="#_count"></a>COUNT</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>COUNT</code> can be expressed using <code>.count()</code>.</p>
</div>
<div class="paragraph">
<p>Stream counting are optimized to database queries. Consider the following stream that counts the number of long films (with a length greater than 120 minutes):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    long noLongFilms = jpaStreamer.stream(Film.class)
        .filter(Film$.length.greaterThan(120))
        .count();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, the code will calculate that there are 457 long films.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_group_by"><a class="anchor" href="#_group_by"></a>GROUP BY</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>GROUP BY</code> can be expressed using <code>collect(groupingBy(&#8230;&#8203;))</code></p>
</div>
<div class="paragraph">
<p>Java has its own group-by <code>collector</code>. The example below groups all the Films by 'rating':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    Map&lt;String, List&lt;Film&gt;&gt; filmCategories = jpaStreamer.stream(Film.class)
        .collect(
            Collectors.groupingBy(
                Film$.rating
            )
        );

        map.forEach((k, v) -&gt;
            System.out.format(
                 "Rating %-5s maps to %d films %n", k, v.size()
            )
        );</code></pre>
</div>
</div>
<div class="paragraph">
<p>This might produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">Rating PG-13 has 223 films
Rating R     has 195 films
Rating NC-17 has 210 films
Rating G     has 178 films
Rating PG    has 194 films</code></pre>
</div>
</div>
<div class="paragraph">
<p>The entire table will be pulled into the application in this example because all films will be in the `Map.</p>
</div>
<div class="paragraph">
<p>To only count the occurrences of items for different classifications a down-stream <code>Collector</code> can be used instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Map&lt;String, Long&gt; map = jpaStreamer.stream(Film.class)
    .collect(
        Collectors.groupingBy(
            // Apply this classifier
            Film$.rating,
            // Then apply this down-stream collector
            Collectors.counting()
        )
    );

    System.out.println(map);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This might produce the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">{PG-13=223, R=195, NC-17=210, G=178, PG=194}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_select"><a class="anchor" href="#_select"></a>SELECT</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_having"><a class="anchor" href="#_having"></a>HAVING</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_join"><a class="anchor" href="#_join"></a>JOIN</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_union"><a class="anchor" href="#_union"></a>UNION</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_offset_2"><a class="anchor" href="#_offset_2"></a>OFFSET</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_group_by_2"><a class="anchor" href="#_group_by_2"></a>GROUP BY</h2>
<div class="sectionbody">

</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
